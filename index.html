<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XPDL Activity Extractor (Link Fix)</title>

    <style>
        /* Basisstijlen blijven hetzelfde */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            line-height: 1.6;
            margin: 20px;
            background-color: #f8f9fa;
            color: #212529;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #ffffff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #343a40;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        input[type="file"] {
            display: block;
            margin-bottom: 15px;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            width: calc(100% - 18px);
        }
        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s ease-in-out;
        }
        button:hover {
            background-color: #0056b3;
        }
        #resultsListContainer {
            margin-top: 25px;
            padding: 20px;
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 4px;
            min-height: 50px;
        }
        #resultsList { list-style: disc; padding-left: 25px; margin: 0; }
        #resultsList li { margin-bottom: 10px; color: #495057; }
        #resultsList ul { list-style: circle; padding-left: 20px; margin-top: 5px; margin-bottom: 5px; }
        #resultsList ul li { margin-bottom: 5px; font-size: 0.95em; color: #333; line-height: 1.4; }
        #resultsList ul li.performer-item { color: #555; font-style: italic; margin-top: 8px; }
        #resultsList ul li.location-item { color: #444; margin-top: 8px; }
        #statusMessage { margin-top: 15px; color: #6c757d; font-style: italic; font-size: 0.9em; }
        .input-group { margin-bottom: 20px; }
        #resultsList li.collapsible { cursor: pointer; }
        .hidden { display: none; }
        .embedded-video-iframe { width: 100%; max-width: 560px; aspect-ratio: 16 / 9; border: none; margin-top: 5px; margin-bottom: 5px; }
        .embedded-video-html5 { width: 100%; max-width: 560px; height: auto; display: block; margin-top: 5px; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>XPDL Activity Extractor</h1>
        <p>Selecteer een XPDL-bestand (XML). De tool zoekt naar Activiteiten die verband houden met "Station". Het toont de Activiteit naam, beschrijvingen, Performer(s), en Lokatie. Klik op Activiteitennamen om details te zien. Videolinks worden ingebed, andere links openen in een nieuw tabblad.</p>

        <div class="input-group">
            <label for="xmlFile">Kies XPDL/XML bestand:</label>
            <input type="file" id="xmlFile" accept=".xml,.xpdl,text/xml">
        </div>

        <button id="processButton">Verwerk XPDL Bestand</button>

        <div id="resultsListContainer">
             <h2>Resultaten (Klik om uit/in te klappen):</h2>
             <ul id="resultsList"></ul>
             <p id="statusMessage"></p>
        </div>
    </div>

    <script>
        // Referenties naar DOM-elementen
        const resultsList = document.getElementById('resultsList');
        const statusMessage = document.getElementById('statusMessage');

        // Event listeners
        document.getElementById('processButton').addEventListener('click', handleFile);
        resultsList.addEventListener('click', handleToggle);

        function handleFile() {
            // (Bestandsleeslogica blijft hetzelfde)
            const fileInput = document.getElementById('xmlFile');
            resultsList.innerHTML = '';
            statusMessage.textContent = 'Verwerken...';
            if (!fileInput.files || fileInput.files.length === 0) { statusMessage.textContent = '⚠️ Selecteer eerst een XML/XPDL bestand.'; return; }
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = function(event) { processXML(event.target.result); };
            reader.onerror = function(event) { /* Foutafhandeling */ statusMessage.textContent = `❌ Fout bij lezen bestand...`; resultsList.innerHTML = ''; };
            reader.readAsText(file);
        }

        function processXML(xmlString) {
            // (XML Parsing, Foutcontrole, Namespace, XPath, Dataverzameling - hetzelfde als voorheen)
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlString, "application/xml");
            if (xmlDoc.documentElement.nodeName === "parsererror") { /* ... foutafhandeling ... */ statusMessage.textContent = `❌ Fout bij parsen XML...`; resultsList.innerHTML = ''; return; }
            const parseErrorElements = xmlDoc.getElementsByTagName("parsererror");
            if (parseErrorElements.length > 0) { /* ... foutafhandeling ... */ statusMessage.textContent = `❌ Fout bij parsen XML...`; resultsList.innerHTML = ''; return; }
            const xpdlNamespace = "http://www.wfmc.org/2004/XPDL2.0alpha";
            function nsResolver(prefix) { return prefix === 'xpdl' ? xpdlNamespace : null; }
            const stationXPath = "//xpdl:ExtendedAttribute[@Value[contains(., 'Station')]]";
            let stationAttributeNodes;
            try { stationAttributeNodes = xmlDoc.evaluate(stationXPath, xmlDoc, nsResolver, XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null); }
            catch (xpathError) { /* ... foutafhandeling ... */ statusMessage.textContent = `❌ Fout bij uitvoeren XPath query...`; resultsList.innerHTML = ''; return; }
            const activityData = new Map();
            for (let i = 0; i < stationAttributeNodes.snapshotLength; i++) { /* ... dataverzamelingslogica met performer en locatie ... */
                 const stationNode = stationAttributeNodes.snapshotItem(i);
                const extendedAttributesNode = stationNode.parentNode;
                if (!extendedAttributesNode || extendedAttributesNode.nodeName !== 'ExtendedAttributes') continue;
                const activityNode = extendedAttributesNode.parentNode;
                 if (!activityNode || activityNode.nodeType !== Node.ELEMENT_NODE) continue;
                const activityName = activityNode.getAttribute('Name');
                if (!activityName) continue;
                const performerNames = [];
                try { /* ... performer lookup ... */
                    const performerXPath = "xpdl:Performers/xpdl:Performer";
                    const performerNodesSnapshot = xmlDoc.evaluate(performerXPath, activityNode, nsResolver, XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);
                    for (let j = 0; j < performerNodesSnapshot.snapshotLength; j++) {
                        const performerNode = performerNodesSnapshot.snapshotItem(j);
                        if (performerNode && performerNode.textContent) {
                            const participantId = performerNode.textContent.trim();
                            if (participantId) {
                                const participantXPath = `//xpdl:Participant[@Id='${participantId}']`;
                                const participantNode = xmlDoc.evaluate(participantXPath, xmlDoc, nsResolver, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
                                if (participantNode) { const name = participantNode.getAttribute('Name'); if (name) { performerNames.push(name); } }
                            }
                        }
                    }
                } catch(perfError) { console.error("Fout bij zoeken naar performer(s):", activityName, perfError); }
                let htmlDescriptionValue = null;
                let locationText = null;
                for (const sibling of extendedAttributesNode.children) { /* ... description and location lookup ... */
                    if (sibling.nodeName === 'ExtendedAttribute') {
                        const attrName = sibling.getAttribute('Name');
                        const attrValue = sibling.getAttribute('Value');
                        if (attrName === 'HTMLDescription' && typeof attrValue === 'string') { htmlDescriptionValue = attrValue; }
                        else if (attrName === '1029' && typeof attrValue === 'string') {
                            const tildeIndex = attrValue.indexOf('~');
                            locationText = (tildeIndex !== -1) ? attrValue.substring(0, tildeIndex).trim() : attrValue.trim();
                        }
                    }
                }
                if (!activityData.has(activityName)) { activityData.set(activityName, { descriptions: [], performers: performerNames, location: locationText }); }
                if (htmlDescriptionValue !== null) { const d = activityData.get(activityName); if(d) d.descriptions.push(htmlDescriptionValue); }
            }


            // --- Resultaten Weergeven (met Lokatie) ---
            resultsList.innerHTML = '';
            if (activityData.size > 0) {
                activityData.forEach((activityInfo, activityName) => {
                    const mainLi = document.createElement('li');
                    mainLi.textContent = activityName;
                    const uniqueDescriptions = new Set(activityInfo.descriptions);
                    const performersExist = activityInfo.performers && activityInfo.performers.length > 0;
                    const descriptionsExist = uniqueDescriptions.size > 0;
                    const locationExists = activityInfo.location !== null && activityInfo.location.trim() !== '';

                    if (performersExist || descriptionsExist || locationExists) {
                        mainLi.classList.add('collapsible');
                        const nestedUl = document.createElement('ul');
                        nestedUl.classList.add('hidden');

                        // EERST: Voeg beschrijvingen toe (verwerkt video's, past links aan)
                        if (descriptionsExist) {
                            uniqueDescriptions.forEach(desc => {
                                const nestedLi = document.createElement('li');
                                processAndAppendContent(nestedLi, desc); // Deze functie handelt nu video/links af
                                nestedUl.appendChild(nestedLi);
                            });
                        }

                         // DAARNA: Voeg performer(s) toe
                        if (performersExist) {
                            const performerLi = document.createElement('li');
                            performerLi.classList.add('performer-item');
                            performerLi.textContent = `Uitvoerder(s): ${activityInfo.performers.join(', ')}`;
                            nestedUl.appendChild(performerLi);
                        }

                        // LAATST: Voeg locatie toe
                        if (locationExists) {
                            const locationLi = document.createElement('li');
                            locationLi.classList.add('location-item');
                            locationLi.textContent = `Lokatie: ${activityInfo.location}`;
                            nestedUl.appendChild(locationLi);
                        }

                        mainLi.appendChild(nestedUl);
                    }
                    resultsList.appendChild(mainLi);
                });
                statusMessage.textContent = `✅ ${activityData.size} unieke Activiteiten gevonden gerelateerd aan 'Station'. Klik op namen om details te zien.`;
            } else {
                statusMessage.textContent = 'ℹ️ Geen ExtendedAttributes gevonden die "Station" bevatten binnen een Activity element.';
            }
        }

        // --- Helper functie om beschrijving te verwerken (AANGEPAST voor target="_blank") ---
        function processAndAppendContent(listItem, descriptionHtml) {
             const tempDiv = document.createElement('div');
             tempDiv.innerHTML = descriptionHtml; // Parseer HTML
             const initialLinks = tempDiv.querySelectorAll('a'); // Vind alle links initieel

             // Loop 1: Vervang video links door embeds
             initialLinks.forEach(link => {
                 const url = link.getAttribute('href');
                 if (!url) return;

                 let replacementElement = null;
                 // Check alleen voor video
                 const youtubeId = getYouTubeId(url);
                 const vimeoId = getVimeoId(url);
                 const isDirectVideo = /\.(mp4|webm|ogg)$/i.test(url);

                 if (youtubeId) replacementElement = createYouTubeEmbed(youtubeId);
                 else if (vimeoId) replacementElement = createVimeoEmbed(vimeoId);
                 else if (isDirectVideo) replacementElement = createVideoElement(url);

                 // Vervang de link door het video embed-element (indien gemaakt)
                 if (replacementElement && link.parentNode) {
                      link.parentNode.replaceChild(replacementElement, link);
                 }
             });

             // --- NIEUW: Loop 2: Pas resterende links aan ---
             const remainingLinks = tempDiv.querySelectorAll('a'); // Vind links opnieuw na mogelijke vervangingen
             remainingLinks.forEach(link => {
                 link.target = '_blank'; // Open in nieuw tabblad
                 link.rel = 'noopener noreferrer'; // Veiligheid
             });
             // --- Einde NIEUW ---


             // Voeg de (mogelijk aangepaste) inhoud toe aan het list item
             while (tempDiv.firstChild) {
                 listItem.appendChild(tempDiv.firstChild);
             }
        }

        // --- Toggle Handler (AANGEPAST om link-klik te negeren) ---
        function handleToggle(event) {
             // --- NIEUW: Check of de klik op een link was ---
             // Gebruik closest('a') om te zien of het doel of een ouder een link is
             if (event.target.closest('a')) {
                 // Doe niets als er op een link is geklikt (laat de link openen)
                 return;
             }
             // --- Einde NIEUW ---

             // Zoek het dichtstbijzijnde bovenliggende LI element dat inklapbaar is
             const mainLi = event.target.closest('li.collapsible');

             // Als de klik op of binnen een inklapbaar LI was (en niet op een link)
             if (mainLi) {
                 // Zoek de direct geneste UL binnen deze LI
                 const nestedUl = mainLi.querySelector(':scope > ul');

                 // Als er een geneste UL bestaat, toggle de 'hidden' class
                 if (nestedUl) {
                     nestedUl.classList.toggle('hidden');
                 }
             }
        }

        // --- Video Helper Functies (hetzelfde als voorheen) ---
        function getYouTubeId(url) { /* ... */
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
         }
        function getVimeoId(url) { /* ... */
            const regExp = /vimeo\.com\/(?:video\/|channels\/[^\/]+\/|groups\/[^\/]+\/videos\/)?(\d+)/i;
            const match = url.match(regExp);
            return match ? match[1] : null;
        }
        function createYouTubeEmbed(videoId) { /* ... */
            const iframe = document.createElement('iframe');
            iframe.src = `https://www.youtube.com/embed/${videoId}`;
            iframe.setAttribute('frameborder', '0');
            iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture');
            iframe.setAttribute('allowfullscreen', '');
            iframe.classList.add('embedded-video-iframe');
            return iframe;
         }
        function createVimeoEmbed(videoId) { /* ... */
            const iframe = document.createElement('iframe');
            iframe.src = `https://player.vimeo.com/video/${videoId}`;
            iframe.setAttribute('frameborder', '0');
            iframe.setAttribute('allow', 'autoplay; fullscreen; picture-in-picture');
            iframe.setAttribute('allowfullscreen', '');
            iframe.classList.add('embedded-video-iframe');
            return iframe;
         }
        function createVideoElement(url) { /* ... */
            const video = document.createElement('video');
            video.src = url;
            video.setAttribute('controls', '');
            video.classList.add('embedded-video-html5');
            video.textContent = 'Uw browser ondersteunt de video tag niet.';
            return video;
         }

    </script>

</body>
</html>

